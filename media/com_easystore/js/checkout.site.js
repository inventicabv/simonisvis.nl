document.addEventListener("alpine:init",()=>{const _=Joomla.getOptions("easystore.base");const p={information:`${_}/index.php?option=com_easystore&task=checkout.getInformation`,shipping:`${_}/index.php?option=com_easystore&task=checkout.getShipping`,payment_methods:`${_}/index.php?option=com_easystore&task=checkout.getPaymentMethods`,cart_data:`${_}/index.php?option=com_easystore&task=checkout.getCartData`,countries:`${_}/index.php?option=com_easystore&task=checkout.getCountries`,states:`${_}/index.php?option=com_easystore&task=checkout.getStates`,settings:`${_}/index.php?option=com_easystore&task=checkout.getCheckoutSettings`,search_guest_user:`${_}/index.php?option=com_easystore&task=checkout.searchGuestUser`};Alpine.data("easystore_checkout",()=>{return{async init(){await this.loadData();this.updateOnShippingChange();this.$watch("coupon.code",()=>{this.coupon.message=""});this.$watch("information.shipping_address.country",async t=>{this.handleShippingCountryChange(t)});this.$watch("information.billing_address.country",async t=>{this.handleBillingCountryChange(t)});this.$watch("information.shipping_address.state",async t=>{this.handleShippingStateChange(t)});this.$watch("active_shipping",async t=>{this.handleActiveShippingChange(t)})},loading:false,loadingShipping:false,searchLoading:false,showError:false,errors:{contactError:{email:""},companyInfoError:{company_name:"",company_id:"",vat_information:""},shippingAddressError:{shipping_customer_name:"",shipping_country:"",shipping_state:"",shipping_city:"",shipping_zip_code:"",shipping_address_line_1:"",shipping_address_line_2:"",shipping_phone:""},billingAddressError:{billing_customer_name:"",billing_country:"",billing_state:"",billing_city:"",billing_zip_code:"",billing_address_line_1:"",billing_address_line_2:"",billing_phone:""},shippingMethodError:{shipping_method:""},paymentMethodError:{payment_method:""}},settings:{},coupon:{showCouponInput:false,code:"",message:""},legal:{terms_and_conditions:false,privacy_policy:false},cart:{},information:{name:"",phone:"",is_billing_and_shipping_address_same:true,shipping_address:{},billing_address:{},save_guest_shipping:false,company_name:"",company_id:"",vat_information:"",email:""},shipping:[],payments:[],urls:{shipping:"",information:"",payment:""},active_shipping:null,shipping_method:{},payment_method:"",countries:[],shipping_states:[],billing_states:[],validVideoFormats:["mp4","avi","mov","mkv","flv","wmv","webm"],stateCache:{},stringifyValue(t){return JSON.stringify(t)},handleErrorForDisabledElements(){for(const t in this.errors){for(const i in this.errors[t]){const s=document.querySelector(`[name="${i}`);if(s?.disabled){this.errors[t][i]=""}}}},handleInputChange(t){const i=t.target;const s=i.getAttribute("name");for(const n in this.errors){if(i.value){if(s in this.errors[n]){this.errors[n][s]=""}}}setTimeout(()=>{this.handleErrorForDisabledElements()},100)},debouncedUpdateShipping:debounce(function(){const{country:t,state:i,city:s,zip_code:n}=this.information.shipping_address;this.updateShipping(t,i??"",s??"",n??"")},100),async handleShippingCountryChange(t){if(t){this.errors.shippingAddressError.shipping_country=""}const i=await this.loadStates(t);this.shipping_states=i;this.information.shipping_address.country=t;await this.updateCartData(this.active_shipping,this.information.shipping_address.country);this.debouncedUpdateShipping()},async handleShippingStateChange(t){await this.updateCartData(this.active_shipping,this.information.shipping_address.country,t,this.information.shipping_address.city,this.information.shipping_address.zip_code);this.debouncedUpdateShipping()},async handleShippingCityChange(t){await this.updateCartData(this.active_shipping,this.information.shipping_address.country,this.information.shipping_address.state,t,this.information.shipping_address.zip_code);this.debouncedUpdateShipping()},async handleShippingZipCodeChange(t){this.updateCartData(this.active_shipping,this.information.shipping_address.country,this.information.shipping_address.state,this.information.shipping_address.city,t);this.debouncedUpdateShipping()},async handleBillingCountryChange(t){const i=await this.loadStates(t);this.billing_states=i},async handleActiveShippingChange(t){this.updateCartData(t,this.information.shipping_address.country,this.information.shipping_address.state,this.information.shipping_address.city,this.information.shipping_address.zip_code)},async handleAutoSelect(){const t=this.countries.length;if(t===1){const i=this.countries[0];await this.handleShippingCountryChange(i.value)}},getFileExtension(t=""){return t.split(".").pop()},get isDisabledPayButton(){return this.settings.show_terms_and_conditions&&!this.legal.terms_and_conditions||this.settings.show_privacy_policy&&!this.legal.privacy_policy},get address(){if(!this.information.shipping_address){return"-"}const t=this.information.shipping_address;return[t.address,t.city,t.state,t.country].filter(t=>!!t).map(t=>`<span>${t}</span>`).join(" ")},async searchGuestUser(t){const i=t.target.value;if(!i){return}this.searchLoading=true;const s=`${p.search_guest_user}&email=${i}`;const n=await fetch(s);const e=await n.json();this.searchLoading=false;if(!!e.data){this.information={...this.information,shipping_address:e.data};const a=e.data;for(const o in a){if(o in this.information.shipping_address){const r=document.querySelector(`[x-model="information.shipping_address.${o}"]`);const h=r.getAttribute("name");if(r){for(const c in this.errors){if(h in this.errors[c]){this.errors[c][h]=""}}r.classList.remove("error-input")}}}}},async loadInformation(){const t=await fetch(p.information);return(await t.json())?.data},async loadShipping(t="",i="",s="",n=""){const e=new URLSearchParams({country:t.toString(),state:i.toString(),city:s.toString(),zip_code:n.toString(),subtotal:this.cart?.sub_total??""});const a=`${p.shipping}&${e.toString()}`;const o=await fetch(a);const r=await o.json();return r.data},async loadPaymentMethods(){const t=await fetch(p.payment_methods);return(await t.json())?.data},async loadCartData(t=null,i=null,s=null,n=null,e=null){const a=[{key:"shipping_id",value:t},{key:"country",value:i},{key:"state",value:s},{key:"city",value:n},{key:"zip_code",value:e}].reduce((t,i)=>{if(i.value){t+=`&${i.key}=${i.value}`}return t},p.cart_data);const o=await fetch(a);return(await o.json())?.data},handleTaxBreakdown(){if(this.$refs.taxBreakdown.classList.contains("hide")){this.$refs.taxBreakdown.classList.remove("hide");this.$el.querySelector("svg").style.transform="rotate(180deg)"}else{this.$refs.taxBreakdown.classList.add("hide");this.$el.querySelector("svg").style.transform="rotate(0deg)"}},async loadCountries(){const t=await fetch(p.countries);return(await t.json())?.data},async loadStates(t){if(this.stateCache[t]){return this.stateCache[t]}try{const i=`${p.states}&country_code=${t??null}`;const s=await fetch(i);if(!s.ok){return[]}const n=(await s.json())?.data;if(Array.isArray(n)){this.stateCache[t]=[...n]}return n}catch(t){return[]}},async loadSettings(){const t=await fetch(p.settings);return(await t.json())?.data},async loadData(){this.loading=true;await Promise.all([this.shouldLoadCountries()?this.initCountries():null,this.shouldLoadInformation()?this.initInformation():null,this.shouldLoadCart()?this.initCart():null,this.shouldLoadShipping()?this.initShipping():null,this.shouldLoadPayments()?this.initPayments():null,this.shouldLoadSettings()?this.initSettings():null]);this.loading=false;await this.handleAutoSelect();this.updateShipping(this.information?.shipping_address?.country??"",this.information?.shipping_address?.state??"",this.information?.shipping_address?.zip_code??"")},async initCountries(){const t=await this.loadCountries();if(Array.isArray(t)&&t.length>0){this.countries=[...t]}},async initInformation(){const t=await this.loadInformation();if(!t)return;this.information={...this.information,...t,shipping_address:t.shipping_address??{},billing_address:t.billing_address??{}};if(this.information.shipping_address?.country){this.shipping_states=await this.loadStates(this.information.shipping_address.country)}if(this.information.billing_address?.country){this.billing_states=await this.loadStates(this.information.billing_address.country)}},async initCart(){const t=await this.loadCartData();this.cart=this.formatCart(t)},async initShipping(){const t=await this.loadShipping();this.shipping=Array.isArray(t)?[...t]:[]},async initPayments(){const t=await this.loadPaymentMethods();this.payments=Array.isArray(t)?[...t]:[];this.payment_method=this.cart?.payment_method||this.payments?.[0]?.name},async initSettings(){const t=await this.loadSettings();if(t){this.settings={...t}}},shouldLoadCountries(){return!Array.isArray(this.countries)||this.countries.length===0},shouldLoadInformation(){return!this.information||Object.keys(this.information).length===0},shouldLoadCart(){return!this.cart||!Array.isArray(this.cart.items)||this.cart.items.length===0},shouldLoadShipping(){return!Array.isArray(this.shipping)||this.shipping.length===0},shouldLoadPayments(){return!Array.isArray(this.payments)||this.payments.length===0},shouldLoadSettings(){return!this.settings||Object.keys(this.settings).length===0},formatCart(t){if(!t)return{};t.items=(t.items||[]).map(t=>{const i=this.validVideoFormats.includes(this.getFileExtension(t?.image?.src));return{...t,isVideo:i,total_price_with_currency:easystore_formatPrice(t.total_price_with_currency),price_with_currency:easystore_formatPrice(t.price_with_currency),discounted_price_with_currency:easystore_formatPrice(t.discounted_price_with_currency)}});t.shipping_method=this.shipping;t.total_with_currency=easystore_formatPrice(t.total_with_currency);t.sub_total_with_currency=easystore_formatPrice(t.sub_total_with_currency);t.coupon_discount_with_currency=easystore_formatPrice(t.coupon_discount_with_currency);t.taxable_amount_with_currency=easystore_formatPrice(t.taxable_amount_with_currency);return t},async updateCartData(t=null,i=null,s=null,n=null,e=null){this.loading=true;const a=await this.loadCartData(t,i,s,n,e);this.cart=a?{...a}:this.cart;this.cart.items.forEach(t=>{t.isVideo=this.validVideoFormats.includes(this.getFileExtension(t?.image?.src));t.total_price_with_currency=easystore_formatPrice(t.total_price_with_currency);t.price_with_currency=easystore_formatPrice(t.price_with_currency);t.discounted_price_with_currency=easystore_formatPrice(t.discounted_price_with_currency)});this.cart.total_with_currency=easystore_formatPrice(this.cart.total_with_currency);this.cart.sub_total_with_currency=easystore_formatPrice(this.cart.sub_total_with_currency);this.cart.coupon_discount_with_currency=easystore_formatPrice(this.cart.coupon_discount_with_currency);this.cart.taxable_amount_with_currency=easystore_formatPrice(this.cart.taxable_amount_with_currency);this.loading=false},async updateShipping(t="",i="",s="",n=""){this.loadingShipping=true;const e=await this.loadShipping(t,i,s,n);if(!e||!Array.isArray(e)){this.shipping=[];this.loadingShipping=false;return}this.shipping=e?[...e]:this.shipping;this.loadingShipping=false},handleAddPromotionClick(){this.coupon.showCouponInput=true;this.$nextTick(()=>{this.$refs.couponInput.focus()})},handleCouponInputOutsideClick(){if(this.coupon.code.length>0){return}this.coupon.showCouponInput=false},updateOnShippingChange(){if(!this.$refs.shippingMethod){return}const t=this.$refs.shippingMethod.querySelectorAll("input[type=radio]");if(!t){return}t.forEach(t=>{t.addEventListener("change",t=>{value=JSON.parse(t.target.value);this.active_shipping=value.uuid})})},async applyCouponCode(t){t.preventDefault();this.loading=true;if(!this.coupon.code){this.coupon.message="The code is required";this.loading=false;return}const i=new FormData;i.append("code",this.coupon.code);i.append("cart_id",this.cart.id);i.append("country",this.information.shipping_address.country);i.append("_method","POST");const s=await fetch(`${Joomla.getOptions("easystore.base")}/index.php?option=com_easystore&task=coupon.applyCoupon`,{method:"POST",body:i});const n=await s.json();if(n.data.message){this.coupon.message=n.data.message;this.loading=false;return}if(n.data.success){this.coupon.showCouponInput=false;this.coupon.code="";await this.updateCartData(this.active_shipping,this.information.shipping_address.country,this.information.shipping_address.state,this.information.shipping_address.city,this.information.shipping_address.zip_code);return}},async removeCouponCode(){const t=new FormData;t.append("cart_id",this.cart.id);t.append("_method","POST");const i=await fetch(`${Joomla.getOptions("easystore.base")}/index.php?option=com_easystore&task=coupon.removeCode`,{method:"POST",body:t});const s=await i.json();if(s.data.success){await this.updateCartData(this.active_shipping,this.information.shipping_address.country,this.information.shipping_address.state,this.information.shipping_address.city,this.information.shipping_address.zip_code)}this.coupon.code=""},async onSubmitPayment(t){const i=new FormData(t.target);if(!i.get("is_billing_and_shipping_address_same")){i.set("is_billing_and_shipping_address_same",0)}else{i.set("is_billing_and_shipping_address_same",1)}const s={name:i.get("shipping_customer_name")??"",country:i.get("shipping_country")??"",state:i.get("shipping_state")??"",city:i.get("shipping_city")??"",zip_code:i.get("shipping_zip_code")??"",address_1:i.get("shipping_address_line_1")??"",address_2:i.get("shipping_address_line_2")??"",phone:i.get("shipping_phone")??""};const n={name:i.get("billing_customer_name")??"",country:i.get("billing_country")??"",state:i.get("billing_state")??"",city:i.get("billing_city")??"",zip_code:i.get("billing_zip_code")??"",address_1:i.get("billing_address_line_1")??"",address_2:i.get("billing_address_line_2")??"",phone:i.get("billing_phone")??""};for(const o of["country","state","city","zip_code","address_line_1","address_line_2","customer_name","phone"]){const r=`shipping_${o}`;const h=`billing_${o}`;if(i.has(r)){i.delete(r)}if(i.has(h)){i.delete(h)}}i.append("shipping_address",JSON.stringify(s));i.append("billing_address",JSON.stringify(n));this.loading=true;const e=await Joomla.request({url:`${_}/index.php?option=com_easystore&task=checkout.placeOrder`,data:i,method:"POST",perform:true,promise:true});const a=JSON.parse(e.response);if(!a.data){return}if(a.data.pluginError===undefined||a.data.pluginError!=null){this.loading=false}if(a.data.code>=400){const c=a.data.message;if(c){Joomla.renderMessages({error:[c]});return}const p=a.data.errors;for(const d of Object.keys(this.errors)){for(const l in p){if(l in this.errors[d]){const u=document.querySelector(`[name="${l}`);if(u){if(!u.disabled){this.errors[d][l]=p[l]}}}}}this.showError=true;this.loading=false;return}if(!!a.data.pluginError){Joomla.renderMessages({error:[a.data.pluginError]})}if(!!a.data.navigationUrl){window.location.href=a.data.navigationUrl}}}})});